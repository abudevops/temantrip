var qualifyURL=function(t){var e=document.createElement("img");return e.src=t,t=e.src,e.src=null,t};!function(t,e,s){function n(e,i){this.element=e,this.$element=t(e),this.settings=t.extend({},r,i),this._columnSize=0,this._defaults=r,this._name=h,this.tiles=[],this._loadedImages=0,this._rows=[[]],this._currentRow=0,this._currentRowTile=0,this.edges=[],this.imagesData={},this.currentWidth=0,this.currentImageSizeFactor=1,this.currentColumnsCount=0,this.ajaxComplete=!1,this.isLoading=!1,this.currentPage=1,this.init()}t.fn.visible=function(i){if(!t(this).offset())return!0;var s=t(this),n=t(e),h=n.scrollTop(),r=h+n.height(),a=s.offset().top,o=a+s.height();return(!0===i?a:o)<=r&&(!0===i?o:a)>=h};var h="finalTilesGallery",r={layout:"final",columns:[[4e3,5],[1024,4],[800,3],[480,2],[320,1]],rowHeight:200,margin:10,minTileWidth:200,ignoreImageAttributes:!0,imageSizeFactor:[[4e3,.9],[1024,.8],[800,.7],[600,.6],[480,.5],[320,.3]],gridSize:10,allowEnlargement:!0,autoLoadURL:null,autoLoadOffset:50,onComplete:function(){},onUpdate:function(){},debug:!1};t.extend(n.prototype,{print:function(t){this.settings.debug&&console.log(t)},setCurrentImageSizeFactor:function(){this.currentImageSizeFactor=1;for(var i=t(e).width(),s=0;s<this.settings.imageSizeFactor.length;s++)this.settings.imageSizeFactor[s][0]>=i&&(this.currentImageSizeFactor=this.settings.imageSizeFactor[s][1]);this.currentImageSizeFactor||(this.currentImageSizeFactor=1),this.print("current image size factor: "+this.currentImageSizeFactor+" ("+i+")")},setCurrentColumnSize:function(){for(var i=t(e).width(),s=0;s<this.settings.columns.length;s++)this.settings.columns[s][0]>=i&&(this.currentColumnsCount=this.settings.columns[s][1]);this._columnSize=Math.floor((this.currentWidth-this.settings.margin*(this.currentColumnsCount-1))/this.currentColumnsCount),console.log(this.currentWidth,this._columnSize,this.currentColumnsCount),this.print(this.currentWidth,this._columnSize)},init:function(){var i=this;if(i.currentWidth=i.$element.width(),0==i.$element.filter(":visible").length)return i.print("cannot initialize the gallery, container is hidden. Retrying in 500ms."),void setTimeout(function(){i.init()},500);this.$element.find(".ftg-items").css({position:"relative"}),this.tiles=this.$element.find(".tile").not(".ftg-hidden"),this.tiles.css({transition:"all .3s"}),this.currentWidth=this.$element.width(),this.print("this.currentWidth: "+this.currentWidth),"columns"!=this.settings.layout&&"rows"!=this.settings.layout&&"final"!=this.settings.layout&&console.log("WARNING: unknown layout, falling back to 'final'."),"columns"==this.settings.layout&&this.setCurrentColumnSize();var n=0;this.setCurrentImageSizeFactor(),t(e).resize(function(){n=setTimeout(function(){i.currentWidth!=i.$element.width()&&(clearTimeout(n),i.print("this.currentWidth",this.currentWidth),i.currentWidth=i.$element.width(),i.setCurrentColumnSize(),i.setCurrentImageSizeFactor(),i.refresh())},500)}),i.isLoading=!0,i.settings.autoLoadURL&&t(e).scroll(function(){i.ajaxComplete||i.isLoading||t(e).scrollTop()>=t(s).height()-t(e).height()-i.settings.autoLoadOffset&&(i.isLoading=!0,t.get(i.settings.autoLoadURL,{page:++i.currentPage},function(e){0==t.trim(e).length?i.ajaxComplete=!0:(i.$element.find(".ftg-items").append(e),i.tiles=i.$element.find(".tile"),i.loadImage())}))}),this.setupFilters(),this.edges.push({left:0,top:0,width:this.currentWidth,index:0}),this.loadImage()},addElements:function(t){this.$element.find(".ftg-items").append(t),this.tiles=this.$element.find(".tile"),this.loadImage()},removeAt:function(t){this.tiles[t].remove(),this.refresh()},clear:function(){this.$element.find(".ftg-items").height(0).empty(),this.refresh()},setupFilters:function(){var e=this;e.$element.find(".ftg-filters a").click(function(i){i.preventDefault(),e.$element.find(".ftg-filters a").removeClass("selected"),t(this).addClass("selected");var s=t(this).attr("href").replace("#ftg-set-","");"ftgall"==s?e.$element.find(".tile").removeClass("ftg-hidden"):e.$element.find(".tile").not(".ftg-set-"+s).addClass("ftg-hidden").end().filter(".ftg-set-"+s).removeClass("ftg-hidden"),e.refresh()})},printEdges:function(){for(this.$element.find(".edge").remove(),i=0;i<this.edges.length;i++){var e=t("<div class='edge' />");e.append("top: "+this.edges[i].top+"<br>"),e.append("left: "+this.edges[i].left+"<br>"),e.append("width: "+this.edges[i].width+"<br>"),e.css({left:this.edges[i].left,top:this.edges[i].top,marginTop:-25,marginLeft:20}),this.$element.append(e)}},printEdge:function(e){var i=t("<div class='edge enlarged-"+e.enlarged+"' />");i.append("<b>"+e.index+" "+e["case"]+"</b><br>"),i.append("t: "+Math.round(e.top)+" l: "+e.left+"<br>"),i.append("width: "+e.width+"<br>"),i.append("idx: "+e.tileIndex+"<br>"),i.css({left:e.left,top:e.top,marginTop:-25,marginLeft:20}),this.$element.append(i)},refresh:function(){this.$element.find(".edge").remove(),this.edges=[{left:0,top:0,width:this.currentWidth}],this.tiles.removeClass("ftg-loaded ftg-enlarged"),this.tiles=this.$element.find(".tile").not(".ftg-hidden"),this._loadedImages=0,this.loadImage()},getAvailableRowSpace:function(){return this.currentWidth-this.getBusyRowSpace()},getBusyRowSpace:function(){for(var t=0,e=0;e<this._rows[this._currentRow].length;e++)t+=this._rows[this._currentRow][e].data("width")+this.settings.margin;return t},addImageToRow:function(t){console.log(this._rows),console.log(this._currentRow),this._rows[this._currentRow].push(t)},fitImagesInRow:function(){this.getAvailableRowSpace(),this.settings.margin;for(var t=(this.currentWidth-(this._rows[this._currentRow].length-1)*this.settings.margin)/this.getBusyRowSpace(),e=0;e<this._rows[this._currentRow].length;e++){$item=this._rows[this._currentRow][e];var i=$item.data("width");$item.data("height");$item.data("width",i*t),this.add(this._currentRowTile++)}},nextTile:function(t){var e=this;if(t&&e.add(e._loadedImages),++e._loadedImages<e.tiles.length)e.loadImage();else{var i=e.lowerEdgeTop();e.print("lower edge top: "+i),e.$element.find(".ftg-items").height(i),e.isLoading=!1,e.settings.onComplete()}},loadImage:function(){var t=this,e=this.tiles.eq(this._loadedImages);e.children("iframe").length&&e.children("iframe").addClass("item");var i=e.find(".item");switch(i.get(0).tagName.toLowerCase()){case"img":var s=new Image;s.onload=function(){var n=t.currentImageSizeFactor;e.data("ftg-ignore-size-factor")&&(n=1);var h={},r=!0;if("final"==t.settings.layout){var a=i.attr("width")?parseInt(i.attr("width")):s.width,o=i.attr("height")?parseInt(i.attr("height")):s.height;h.width=a*n,h.height=o*n}"columns"==t.settings.layout&&(h.width=t._columnSize,h.height=h.width*s.height/s.width),"rows"==t.settings.layout&&(h.width=t.settings.rowHeight*s.width/s.height,h.height=t.settings.rowHeight,r=!1,t.getAvailableRowSpace()>h.width?t.addImageToRow(i):(t.fitImagesInRow(),t._currentRow++,t._rows.push([]),t.addImageToRow(i))),i.attr("src",this.src),t.imagesData["tile"+t._loadedImages]={width:h.width,height:h.height,owidth:s.width,oheight:s.height,src:s.src},t.nextTile(r)},s.onerror=function(){t.print("error loading image: "+s.src),t.nextTile(!0)},s.src=i.data("src"),e.data("ftg-type","image");break;case"iframe":t.imagesData["tile"+t._loadedImages]={width:parseInt(i.attr("width")),height:parseInt(i.attr("height")),owidth:parseInt(i.attr("width")),oheight:parseInt(i.attr("height"))},e.data("ftg-type","iframe"),t.nextTile(!0);break;default:t.imagesData["tile"+t._loadedImages]={width:parseInt(i.data("width")),height:parseInt(i.data("height")),owidth:parseInt(i.data("width")),oheight:parseInt(i.data("height"))},t.nextTile(!0)}},higherEdge:function(){for(var t=1e5,e=0,i=0;i<this.edges.length;i++)this.edges[i].top<t&&(e=i,t=this.edges[i].top);return this.edges[e]},lowerEdgeTop:function(){for(var t=0,e=0;e<this.edges.length;e++)this.edges[e].top>t&&(t=this.edges[e].top);return t},alignEdge:function(t){for(var e=0;e<this.edges.length;e++)if(this.edges[e].left+this.edges[e].width+this.settings.margin==t.left&&(this.print("found edge on left",e),t.top==this.edges[e].top))return this.print("edges can be aligned [1]"),{side:"left",edge:this.edges[e]};for(e=0;e<this.edges.length;e++)if(this.edges[e].left-this.settings.margin==t.left+t.width&&(this.print("found edge on right",e),t.top==this.edges[e].top))return this.print("edges can be aligned [2]"),{side:"right",edge:this.edges[e]};return null},removeEdge:function(t){for(var e=[],i=0;i<this.edges.length;i++)this.edges[i]!=t&&e.push(this.edges[i]);this.edges=e},add:function(t){var e=this.tiles.eq(t),i=e.find(".item"),s="tile"+t,n=this.imagesData[s].width,h=this.imagesData[s].height,r=this.higherEdge();if(this.print(r),r.tileIndex=t,this.print(t+" ["+e.data("ftg-type")+"] ("+n+"x"+h+")"),r.top>0&&(r.top+=this.settings.margin),e.css({left:r.left,top:r.top,position:"absolute"}),r.enlarged=!1,r.width<n+this.settings.margin){r["case"]="Te",this.print("Te",r.width);var a=h/n*(d=r.width);d+r.left-this.settings.margin==this.currentWidth&&(this.print("END"),a=h/n*(d-=this.settings.margin)),n=d,h=a}else if(r.width>n)if(this.print("tE"),"columns"==this.settings.layout||r.width-n>=this.settings.minTileWidth){r["case"]="tE",this.print("tE1",r.width,r.left,this.currentWidth);var o={left:r.left+n+this.settings.margin,top:r.top-(r.top>0?this.settings.margin:0),width:r.width-n-this.settings.margin,marginLeft:!0,"case":"NEW",index:r.index+1};this.edges.push(o)}else{r["case"]="tE2",this.print("tE2"),this.print("enlargement",r.width,r.left,this.currentWidth);r.left+r.width==this.currentWidth||this.settings.margin;var d=r.width;a=this.settings.allowEnlargement&&"rows"!=this.settings.layout?h/n*d:h;this.settings.allowEnlargement?(e.addClass("ftg-enlarged"),r.enlarged=!0):"rows"!=this.settings.layout&&e.find(".item").css({width:n,height:h}),n=d,h=a}if(r.top+=h,this.settings.gridSize){var g=r.top%this.settings.gridSize;r.top-=g,h-=g}r.left=r.left,r.width=n;var l=!0,c=this.alignEdge(r,t);c&&("left"==c.side?(this.removeEdge(r),c.edge.width+=n+this.settings.margin,h-=r.top-c.edge.top,r.top-=h,l=!1):(this.removeEdge(c.edge),r.width+=this.settings.margin+c.edge.width,l=!1),e.height(h)),this.$element.find(".ftg-items").height()<r.top&&this.$element.find(".ftg-items").height(r.top),this.settings.debug&&l&&this.printEdge(r),"iframe"==e.data("ftg-type")&&e.find("iframe").height(h),this.print(n+"x"+h),this.print("----"),e.css({width:n,height:h});var f=n/this.imagesData[s].width,u=this.imagesData[s].height*f-h;i.css({height:"auto"}),u>0&&i.css({top:0-u/2}),e.addClass("ftg-loaded")}}),t.fn[h]=function(e){return this.each(function(){t.data(this,h)||t.data(this,h,new n(this,e))}),this},t(function(){t(".ftg-social a").click(function(i){i.preventDefault();var n=t(this).data("social"),h=t(this).parents(".tile").first(),r=h.data("big");r||(r=h.find(".item").attr("src"));var a=t.trim(h.find(".caption").text());if(a.length||(a=s.title),"facebook"==n){var o="https://www.facebook.com/dialog/feed?app_id=1447224948871585&link="+encodeURIComponent(location.href)+"&display=popup&name="+encodeURIComponent(s.title)+"&caption=&description="+encodeURIComponent(a)+"&picture="+encodeURIComponent(qualifyURL(r))+"&ref=share&actions={%22name%22:%22View%20the%20gallery%22,%20%22link%22:%22"+encodeURIComponent(location.href)+"%22}&redirect_uri=http://final-tiles-gallery.com/facebook_redirect.html";e.open(o,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}"twitter"==n&&e.open("https://twitter.com/intent/tweet?url="+encodeURI(location.href.split("#")[0])+"&text="+encodeURI(a),"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200);if("pinterest"==n){o="http://pinterest.com/pin/create/button/?url="+encodeURIComponent(location.href)+"&description="+encodeURI(a);o+="&media="+encodeURIComponent(qualifyURL(r)),e.open(o,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}if("google-plus"==n){o="https://plus.google.com/share?url="+encodeURI(location.href);e.open(o,"ftgw","location=1,status=1,scrollbars=1,width=600,height=400").moveTo(screen.width/2-300,screen.height/2-200)}})})}(jQuery,window,document);